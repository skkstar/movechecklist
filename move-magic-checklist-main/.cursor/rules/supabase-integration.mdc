---
globs: src/integrations/supabase/*,src/hooks/useAuth.tsx
description: Supabase and database integration rules
---

# ðŸ—„ï¸ Supabase & Database Integration

## ðŸ”§ Supabase Client Usage
- **Client Instance**: [src/integrations/supabase/client.ts](mdc:move-magic-checklist-main/src/integrations/supabase/client.ts)
- **Type Definitions**: [src/integrations/supabase/types.ts](mdc:move-magic-checklist-main/src/integrations/supabase/types.ts)
- **Authentication Hook**: [src/hooks/useAuth.tsx](mdc:move-magic-checklist-main/src/hooks/useAuth.tsx)

## ðŸ”’ Security Rules
- âœ… **Row Level Security (RLS)** - Always enabled
- âœ… **User-specific data isolation** - Use `auth.uid() = user_id`
- âœ… **Error handling** - Always implement try-catch
- âœ… **Loading states** - Show loading indicators
- âŒ **Never expose sensitive data** - Use proper RLS policies

## ðŸ“Š Database Query Patterns
```typescript
// âœ… Data Fetching with Error Handling
const loadData = async () => {
  try {
    setLoading(true);
    const { data, error } = await supabase
      .from('moving_checklists')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at');

    if (error) {
      console.error('Error loading data:', error);
      toast.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    setData(data);
  } catch (error) {
    console.error('Unexpected error:', error);
  } finally {
    setLoading(false);
  }
};

// âœ… Data Insertion
const createItem = async (itemData: InsertData) => {
  const { data, error } = await supabase
    .from('table_name')
    .insert({ ...itemData, user_id: user.id })
    .select()
    .single();

  if (error) throw error;
  return data;
};

// âœ… Data Update
const updateItem = async (id: string, updates: UpdateData) => {
  const { error } = await supabase
    .from('table_name')
    .update(updates)
    .eq('id', id)
    .eq('user_id', user.id); // Security: ensure user owns the record

  if (error) throw error;
};
```

## ðŸ” Authentication Patterns
```typescript
// âœ… Google OAuth Sign-in
const signInWithGoogle = async () => {
  const redirectUrl = `${window.location.origin}/`;
  await supabase.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: redirectUrl }
  });
};

// âœ… User Profile Creation
const createUserProfile = async (user: User) => {
  const { data: existingProfile } = await supabase
    .from('profiles')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!existingProfile) {
    await supabase.from('profiles').insert({
      user_id: user.id,
      display_name: user.user_metadata?.full_name || user.email?.split('@')[0],
      email: user.email,
      avatar_url: user.user_metadata?.avatar_url,
    });
  }
};
```

## ðŸ“ˆ Real-time Subscriptions
```typescript
// âœ… Real-time Data Updates
useEffect(() => {
  const subscription = supabase
    .channel('checklist_changes')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'moving_checklists',
      filter: `user_id=eq.${user.id}`
    }, (payload) => {
      // Handle real-time updates
      handleRealtimeUpdate(payload);
    })
    .subscribe();

  return () => subscription.unsubscribe();
}, [user.id]);
```

## ðŸš¨ Error Handling Best Practices
- **Network Errors**: Show user-friendly messages
- **Permission Errors**: Redirect to login if needed
- **Validation Errors**: Display field-specific errors
- **Unexpected Errors**: Log details, show generic message